<!DOCTYPE html>

<title>Add a friend form</title>
<link href=style.css rel=stylesheet>
<h3>Add a friend form</h3>
<form>
<img id=profilepic alt=":peerid" src=https://api.adorable.io/avatar/256/:peerid.png></td>
<b><span id=self>my</span> friends (<span class=shortid>:shortid</span>):</b>
<br><input type=text name=nickname value="michelc" placeholder="nickname">
<br><input type=text name=fullname value="Michel Combes" placeholder="fullname">
<select name=trust><option value=1>trusted</option><option value=0 selected>untrusted</option></select>
<br><input type=text name=city value="" placeholder="city">
<br><input type=text name=peerkey value="QmcfHufAK9ErQ9ZKJF7YX68KntYYBJngkGDoVKcZEJyRve" placeholder="peerkey">
<br><input type=text name=obs value="" placeholder="observation">
<br><input type=text name=phone value="" placeholder="phone number">
<br><input type=text name=email value="" placeholder="email">
<br><input type=text name=last4 value="" placeholder="last 4 digits of physical ID">
<br><input type=text name=peerid value=":peerid" placeholder="peerid" disabled>
<br><button type=button onclick="addFriend(event)">add</button>
</form>Object
<br>

<div id=output>
<h3>friends list</h3>
<table id=friendstableid>
<tr><th>#</th><th>pic.</th><th>nickname</th><th>peerkey</th><th>fullname</th><th>from</th><th>trust</th><th>nid</th><th>obs.</th>
<tr><td>:idx</td>
<td><img class=thumbnail src=https://api.adorable.io/avatar/18/:peerkey.png></td>
<td class=nickname title=":key" ><a href=resolver.html#urn::key:/my/identity/./public.yml>:nickname</a></td>
<td><a class=peerkey href=http://localhost:8080/ipns/:peerkey title=:peerkey>:shortpeerkey</td>
<td>:fullname</td>
<td><a href=http://localhost:8080/ipns/:peerid title=:peerid>:shortpeerid</td>
<td><select name=trust value=":trust" onchange="updateTrust(event)">
    <option value=0>untrusted</option>
    <option value=1>trusted</option>
    </select></td>
<td>:nid</td>
<td>:obs</td>
</table>
</div>

<script src="js/sha256.js" type=text/javascript></script>
<script src="js/js-yaml.js" type=text/javascript></script>
<script src="js/essential.js" type=text/javascript></script>
<script src="js/ipfs.js" type=text/javascript></script>

<script type=text/javascript>
const ff = '/my/friends/peerids.yml';
console.log('ff:',ff)
let friends = {}

// detect when peerid is available and feed it to then...
Promise.resolve(promisedPeerId)
.then( peerid => {
      console.error('peerid:',peerid)
      let e = document.getElementById('profilepic');
      e.src = e.src.replace(/:peerid/,peerid)
      e.alt = peerid

      let shortid = peerid.substr(0,7);
      console.log('shortid: ',shortid);
      replaceInTagsByClassName('shortid',shortid)
      return peerid
})
.then( replacePeerIdInForm )
.catch(console.error);


/*
load(window).then( _ => { // on window load ...
  console.error('peerid:',peerid)
 });
*/




async function main() {
let yml = await getMFSFileContent(ff);
//console.log('yml:',yml)
if (typeof(yml.Code) == 'undefined') {
   friends = window.jsyaml.safeLoad(yml);
} else {
  friend = {};
}
console.log('friends:',friends)
display(friends)
  
}
main()

let tic = getTic()
console.log('tic:',tic)


function display(friendsmap) {
  let [callee,caller] = functionNameJS();
  let table = document.getElementById('friendstableid')
  let pos = 1;
  clear_table(table,pos);
  let last = table.rows.length-1;
  let lastrow = table.rows[last];
  console.log('friendsmap:',friendsmap)
  console.log('friendsmap.keys:',Object.keys(friendsmap))
  for (let i in Object.keys(friendsmap)) {
     let key = Object.keys(friendsmap)[i]
     console.log('friendsmap['+key+'].nickname:',friendsmap[key].nickname)
   let newrow = table.insertRow(pos); // insert before template-row's position;
   let buf = lastrow.innerHTML; // copy previous row content
   buf = buf.replace(/:key/g,key)
   buf = buf.replace(':idx',i)
   let friend = friendsmap[key];
   let shortpeerid = shortqm(friend.peerid)
   buf = buf.replace(':shortpeerid',shortpeerid)
   let shortpeerkey = shortqm(friend.peerkey)
   buf = buf.replace(':shortpeerkey',shortpeerkey)
   for (name of Object.keys(friend)) {
      buf = buf.replace(new RegExp(':'+name,'g'),friend[name]);
      if (name == 'trust' && friend.trust == 1 ) { console.log(callee+'.buf.after:',buf) }
   }
   let nid = getNid('urn:ipns:'+friend.peerkey) // urn = urn:nid:/mfspath
   buf = buf.replace(':nid',nid)

   newrow.innerHTML = buf;
   displayTrust(friend.trust,newrow)

  }

}

function displayTrust(value,row) {
  let [callee,caller] = functionNameJS();
   let sel = row.getElementsByTagName('select')[0]
   //let options = sel.getElementsByTagName('option')
   let options = sel.options
   console.log(callee+'.value:',value)

   for (let j = 0; j < options.length; j++) {

      if (options[j].value == value) {    
         sel.selectedIndex = j
         options[j].selected = true
         break;
      }
   }
   console.log(callee+'.sel:',sel)

}

async function updateTrust(ev) {
   let [callee,caller] = functionNameJS();
   console.log(callee+'.input.ev:',ev)
   let el = ev.target.parentNode.parentNode
   console.log(callee+'.el:',el)
   /* 
   // /!\ hashkey: is unsalted
   let key = hashkey('urn:ipns:'+peerid) // urn = urn:ipms:hashkey:/mfspath
   console.log(callee+'.key:',key)
   */
   
   let nickname = el.getElementsByClassName('nickname')[0].innerHTML;
   let key = el.getElementsByClassName('nickname')[0].title;
   let peerkey = el.getElementsByClassName('peerkey')[0].title;

   console.log(callee+'.nickname:',nickname)
   console.log(callee+'.key:',key)
   console.log(callee+'.peerkey:',peerkey)

   console.log(callee+'.record.before:',JSON.stringify(friends[key]))
   console.log(callee+'.record.trust.before:',friends[key].trust)
   friends[key]['trust'] = ev.target.value
   console.log(callee+'.record.trust.after:',friends[key].trust)
   
   let yml = window.jsyaml.safeDump(friends)
   let hash = await ipfsWriteContent(ff,"--- # friends list (yaml)\n"+yml)
 
}

async function addFriend(ev) {
   console.log('ev:',ev)
   let form = ev.target.parentNode;
   console.log('form:',form)
   let query = getQuery(form);
   let json = query2json(query)
   console.log('json:',json)
   json.nickname = json.nickname.replace(/\s+$/,'')
   json.nickname = json.nickname.replace(/\s+/g,'-')
   let key = getNid('urn:ipns:'+json.peerkey)



   friends[key] = json; // merge w/ existing friends list
   console.log('friends:',friends)
   let yml = window.jsyaml.safeDump(friends)
   console.log('yml:',yml)
   let hash = await ipfsWriteContent(ff,"--- # friends list (yaml)\n"+yml)
   
}

function clear_table(t,pos) {
   console.log('t:',t)
   t.rows[pos].style.display=''; 
   //t.rows[pos].style.display='none'; 
   for (i = t.rows.length-1; i > pos; i--) {
      t.deleteRow(i)
   }
   console.log('nrow after delete:',t.rows.length)
}

function replacePeerIdInForm(id) { 
  let forms = document.getElementsByTagName('form');
  console.log('forms: ',forms);
  if (forms.length > 0) {
     let e = forms[0].elements['peerid'];
     console.log('peerid: '+id)
     if (typeof(e) != 'undefined') {
       console.log(e.outerHTML)
       e.value = e.value.replace(new RegExp(':peerid','g'),id)
     }
  }
  return id
}

</script>
